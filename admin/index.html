<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WMS Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ExcelJS -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="config/config.js"></script>
  <script>
    // ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
    function checkAuth() {
      const user = JSON.parse(localStorage.getItem('user'));
      if (!user || user.role !== 'admin') {
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    function logout() {
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    async function loadSection(name) {
      if (!checkAuth()) return;
      
      console.log('Loading section:', name);
      
      // Cleanup previous section
      const mainContent = document.getElementById("mainContent");
      if (mainContent) {
        console.log('Cleaning up previous section...');
        // Remove all event listeners and cleanup
        const oldContent = mainContent.innerHTML;
        mainContent.innerHTML = '';
        
        // Remove old scripts
        const oldScripts = document.querySelectorAll('script[data-section]');
        oldScripts.forEach(script => {
          console.log('Removing old script:', script.src);
          script.remove();
        });
      }

      // Load new section HTML
      console.log('Loading section HTML...');
      const res = await fetch(`./sections/${name}.html`);
      const html = await res.text();
      mainContent.innerHTML = html;
      
      // JS íŒŒì¼ëª… ë§¤í•‘
      let jsName = name;
      if (name === 'receiving_plan') jsName = 'receiving';
      if (name === 'shipping_plan') jsName = 'shipping';
      if (name === 'receiving') jsName = 'receiving_admin';
      
      // Load section-specific JavaScript (ë™ì  import)
      console.log('Loading section JS:', jsName);
      try {
        const module = await import(`./js/${jsName}.js`);
        console.log('Module loaded:', module);
        if (typeof module.initSection === 'function') {
          console.log('Calling initSection...');
          await module.initSection();
          console.log('initSection completed');
        } else {
          console.error('initSection function not found in module');
        }
      } catch (e) {
        console.error('ì„¹ì…˜ JS ë¡œë“œ/ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      }
    }

    // Add hash change handler
    window.addEventListener('hashchange', () => {
      location.reload();
    });

    // Initial load
    window.addEventListener('load', () => {
      if (!checkAuth()) return;
      console.log('Window loaded');
      console.log('Current URL:', window.location.href);
      console.log('Current hash:', window.location.hash);
      const section = window.location.hash.slice(1) || 'receiving_plan';
      console.log('Loading section:', section);
      loadSection(section);
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside style="width: 256px; background-color: #1f2937; color: white; padding: 24px; min-height: 100vh; border-right: 4px solid #3b82f6; flex-shrink: 0; position: fixed; left: 0; top: 0; z-index: 1000;">
      <div class="mb-8 flex justify-between items-center">
        <div>
          <div class="text-2xl font-bold mb-2" data-i18n="admin_title">WMS Admin</div>
          <div class="text-sm text-gray-400" data-i18n="admin_sub">Warehouse Management</div>
        </div>
        <div class="flex space-x-2">
          <button class="lang-btn px-3 py-1 rounded bg-blue-600 text-white text-sm" data-lang="ko">í•œêµ­ì–´</button>
          <button class="lang-btn px-3 py-1 rounded bg-gray-300 text-gray-800 text-sm" data-lang="en">English</button>
        </div>
      </div>
      <nav style="margin-top: 16px;">
        <div style="display: block; padding: 12px 16px; margin-bottom: 8px; background-color: #374151; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 500;">
          <a href="#receiving_plan" style="color: white; text-decoration: none;" data-i18n="menu_receiving">ğŸ“¦ Receiving Plan</a>
        </div>
        <div style="display: block; padding: 12px 16px; margin-bottom: 8px; background-color: #374151; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 500;">
          <a href="#location_view" style="color: white; text-decoration: none;" data-i18n="menu_location">ğŸ“ Location View</a>
        </div>
        <div style="display: block; padding: 12px 16px; margin-bottom: 8px; background-color: #374151; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 500;">
          <a href="#shipping_confirmation_admin" style="color: white; text-decoration: none;" data-i18n="menu_shipping">ğŸšš Shipping Confirmation</a>
        </div>
        <div style="display: block; padding: 12px 16px; margin-bottom: 8px; background-color: #374151; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 500;">
          <a href="#report" style="color: white; text-decoration: none;" data-i18n="menu_report">ğŸ“Š Report</a>
        </div>
        <div style="display: block; padding: 12px 16px; margin-bottom: 8px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: bold;">
          <a href="#daily_report" style="color: white; text-decoration: none;">ğŸ“ˆ ì¼ì¼ ì…ì¶œê³  ë¦¬í¬íŠ¸</a>
        </div>
        <!-- ë§ˆìŠ¤í„° ê´€ë¦¬ ë©”ë‰´ -->
        <div id="masterMenu" style="margin-bottom: 8px;">
          <div id="masterMenuToggle" style="display: block; padding: 12px 16px; background-color: #7c3aed; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
            <span>âš™ï¸ ë§ˆìŠ¤í„° ê´€ë¦¬</span>
            <span id="masterMenuArrow" style="float: right;">â–¼</span>
          </div>
          <div id="masterSubMenu" style="display: none; margin-top: 4px; padding-left: 8px;">
            <div style="display: block; padding: 10px 16px; margin-bottom: 4px; background-color: #16a34a; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">
              <a href="location_master.html" target="_blank" style="color: white; text-decoration: none;">âš™ï¸ ì¥ì†Œ ë§ˆìŠ¤í„° ê´€ë¦¬</a>
            </div>
            <div style="display: block; padding: 10px 16px; margin-bottom: 4px; background-color: #dc2626; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">
              <a href="flagged_containers.html" target="_blank" style="color: white; text-decoration: none;">ğŸš¨ ë¬¸ì œ ì»¨í…Œì´ë„ˆ ê´€ë¦¬</a>
            </div>
            <div style="display: block; padding: 10px 16px; margin-bottom: 4px; background-color: #9333ea; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">
              <a href="location_editor.html" target="_blank" style="color: white; text-decoration: none;">ğŸ—ºï¸ ì‹œê°ì  ìœ„ì¹˜ í¸ì§‘ê¸°</a>
            </div>
            <div style="display: block; padding: 10px 16px; margin-bottom: 4px; background-color: #059669; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">
              <a href="delivery_locations.html" target="_blank" style="color: white; text-decoration: none;">ğŸšš Delivery Location ê´€ë¦¬</a>
            </div>
          </div>
        </div>
      </nav>
      <div class="mt-8">
        <button onclick="logout()" class="text-sm text-gray-400 hover:text-white" data-i18n="logout">Logout</button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main style="flex: 1; padding: 40px; background-color: #f3f4f6; margin-left: 256px;">
      <div id="mainContent" class="w-full mx-auto">
        <h1 class="text-3xl font-bold" data-i18n="welcome">ğŸ“¦ Welcome to WMS Admin</h1>
        <p class="text-gray-600 mt-2" data-i18n="main_guide">Please select a section from the left menu.</p>
      </div>
    </main>
  </div>
  <script>
    // i18n ê°ì²´
    const i18n = {
      ko: {
        admin_title: 'WMS ê´€ë¦¬ì',
        admin_sub: 'ì°½ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ',
        menu_receiving: 'ì…ê³  ê³„íš',
        menu_location: 'ìœ„ì¹˜ ë³´ê¸°',
        menu_shipping: 'ì¶œê³  í™•ì •',
        menu_report: 'ë³´ê³ ì„œ',
        logout: 'ë¡œê·¸ì•„ì›ƒ',
        welcome: 'ğŸ“¦ WMS ê´€ë¦¬ìì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤',
        main_guide: 'ì™¼ìª½ ë©”ë‰´ì—ì„œ ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”.'
      },
      en: {
        admin_title: 'WMS Admin',
        admin_sub: 'Warehouse Management',
        menu_receiving: 'Receiving Plan',
        menu_location: 'Location View',
        menu_shipping: 'Shipping Confirmation',
        menu_report: 'Report',
        logout: 'Logout',
        welcome: 'ğŸ“¦ Welcome to WMS Admin',
        main_guide: 'Please select a section from the left menu.'
      }
    };
    function setLang(lang) {
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'bg-gray-300', 'text-gray-800'));
      document.querySelector('.lang-btn[data-lang="' + lang + '"]').classList.add('bg-blue-600', 'text-white');
      document.querySelectorAll('.lang-btn:not([data-lang="' + lang + '"])').forEach(btn => btn.classList.add('bg-gray-300', 'text-gray-800'));
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang][key]) el.textContent = i18n[lang][key];
      });
      document.documentElement.lang = lang;
      localStorage.setItem('admin_lang', lang);
    }
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.onclick = () => setLang(btn.getAttribute('data-lang'));
    });
    // ì´ˆê¸° ì–¸ì–´ ì„¤ì •
    setLang(localStorage.getItem('admin_lang') || 'ko');
    
    // ë§ˆìŠ¤í„° ê´€ë¦¬ ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', () => {
      const masterMenuToggle = document.getElementById('masterMenuToggle');
      const masterSubMenu = document.getElementById('masterSubMenu');
      const masterMenuArrow = document.getElementById('masterMenuArrow');
      
      if (masterMenuToggle && masterSubMenu && masterMenuArrow) {
        // ì´ˆê¸° ìƒíƒœ: ë‹«í˜
        masterSubMenu.style.display = 'none';
        masterMenuArrow.textContent = 'â–¶';
        
        masterMenuToggle.addEventListener('click', () => {
          if (masterSubMenu.style.display === 'none') {
            masterSubMenu.style.display = 'block';
            masterMenuArrow.textContent = 'â–¼';
          } else {
            masterSubMenu.style.display = 'none';
            masterMenuArrow.textContent = 'â–¶';
          }
        });
      }
    });
  </script>
</body>
</html>